"use strict";(self.webpackChunkhuman_and_machine=self.webpackChunkhuman_and_machine||[]).push([[8831],{3905:function(t,e,n){n.d(e,{Zo:function(){return p},kt:function(){return h}});var r=n(67294);function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function a(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function i(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?a(Object(n),!0).forEach((function(e){o(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function c(t,e){if(null==t)return{};var n,r,o=function(t,e){if(null==t)return{};var n,r,o={},a=Object.keys(t);for(r=0;r<a.length;r++)n=a[r],e.indexOf(n)>=0||(o[n]=t[n]);return o}(t,e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);for(r=0;r<a.length;r++)n=a[r],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(o[n]=t[n])}return o}var s=r.createContext({}),u=function(t){var e=r.useContext(s),n=e;return t&&(n="function"==typeof t?t(e):i(i({},e),t)),n},p=function(t){var e=u(t.components);return r.createElement(s.Provider,{value:e},t.children)},l={inlineCode:"code",wrapper:function(t){var e=t.children;return r.createElement(r.Fragment,{},e)}},d=r.forwardRef((function(t,e){var n=t.components,o=t.mdxType,a=t.originalType,s=t.parentName,p=c(t,["components","mdxType","originalType","parentName"]),d=u(n),h=o,m=d["".concat(s,".").concat(h)]||d[h]||l[h]||a;return n?r.createElement(m,i(i({ref:e},p),{},{components:n})):r.createElement(m,i({ref:e},p))}));function h(t,e){var n=arguments,o=e&&e.mdxType;if("string"==typeof t||o){var a=n.length,i=new Array(a);i[0]=d;var c={};for(var s in e)hasOwnProperty.call(e,s)&&(c[s]=e[s]);c.originalType=t,c.mdxType="string"==typeof t?t:o,i[1]=c;for(var u=2;u<a;u++)i[u]=n[u];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},76714:function(t,e,n){n.r(e),n.d(e,{frontMatter:function(){return c},contentTitle:function(){return s},metadata:function(){return u},toc:function(){return p},default:function(){return d}});var r=n(87462),o=n(63366),a=(n(67294),n(3905)),i=["components"],c={id:"18-16-persistent-auth-state-with-local-storage",title:"18.16 Persistent Auth State with localStorage",date:new Date("2021-07-22T13:56:32.000Z")},s=void 0,u={unversionedId:"react-complete-guide/18-adding-authentication-to-our-burger-project/18-16-persistent-auth-state-with-local-storage",id:"react-complete-guide/18-adding-authentication-to-our-burger-project/18-16-persistent-auth-state-with-local-storage",title:"18.16 Persistent Auth State with localStorage",description:"auth.js",source:"@site/courses/react-complete-guide/18-adding-authentication-to-our-burger-project/18-16-persistent-auth-state-with-local-storage.md",sourceDirName:"react-complete-guide/18-adding-authentication-to-our-burger-project",slug:"/react-complete-guide/18-adding-authentication-to-our-burger-project/18-16-persistent-auth-state-with-local-storage",permalink:"/hm/ru/courses/react-complete-guide/18-adding-authentication-to-our-burger-project/18-16-persistent-auth-state-with-local-storage",editUrl:"https://github.com/papa31/hm/edit/documentation/courses/react-complete-guide/18-adding-authentication-to-our-burger-project/18-16-persistent-auth-state-with-local-storage.md",tags:[],version:"current",lastUpdatedBy:"PaPa31",lastUpdatedAt:1631602446,formattedLastUpdatedAt:"14.09.2021",frontMatter:{id:"18-16-persistent-auth-state-with-local-storage",title:"18.16 Persistent Auth State with localStorage",date:"2021-07-22T13:56:32.000Z"},sidebar:"Docs",previous:{title:"18.15 Redirecting the User To the Checkout Page",permalink:"/hm/ru/courses/react-complete-guide/18-adding-authentication-to-our-burger-project/18-15-redirecting-user-to-checkout-page"},next:{title:"18.17 Fixing Connect + Routing Errors",permalink:"/hm/ru/courses/react-complete-guide/18-adding-authentication-to-our-burger-project/18-17-fixing-connect-plus-routing-errors"}},p=[{value:"<code>auth.js</code>",id:"authjs",children:[],level:2},{value:"<code>index.js</code>",id:"indexjs",children:[],level:2},{value:"<code>App.js</code>",id:"appjs",children:[],level:2}],l={toc:p};function d(t){var e=t.components,n=(0,o.Z)(t,i);return(0,a.kt)("wrapper",(0,r.Z)({},l,n,{components:e,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"authjs"},(0,a.kt)("inlineCode",{parentName:"h2"},"auth.js")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="src\\store\\actions\\auth.js" {26-28,60-65,82-102}',title:'"src\\store\\actions\\auth.js"',"{26-28,60-65,82-102}":!0},'import axios from "axios";\nimport * as actionTypes from "./actionTypes";\n\nexport const authStart = () => {\n  return {\n    type: actionTypes.AUTH_START,\n  };\n};\n\nexport const authSuccess = (token, userId) => {\n  return {\n    type: actionTypes.AUTH_SUCCESS,\n    idToken: token,\n    userId: userId,\n  };\n};\n\nexport const authFail = (error) => {\n  return {\n    type: actionTypes.AUTH_FAIL,\n    error: error,\n  };\n};\n\nexport const logout = () => {\n  localStorage.removeItem("token");\n  localStorage.removeItem("expirationDate");\n  localStorage.removeItem("userId");\n  return {\n    type: actionTypes.AUTH_LOGOUT,\n  };\n};\n\nexport const checkAuthTimeout = (expirationTime) => {\n  return (dispatch) => {\n    setTimeout(() => {\n      dispatch(logout());\n    }, expirationTime * 1000);\n  };\n};\n\nexport const auth = (email, password, isSignup) => {\n  return (dispatch) => {\n    dispatch(authStart());\n    const authData = {\n      email: email,\n      password: password,\n      returnSecureToken: true,\n    };\n    let url =\n      "https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=AIzaSyDsmwPeH2yE7yqvoeYolCLgB9ju50rYivo";\n    if (!isSignup) {\n      url =\n        "https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=AIzaSyDsmwPeH2yE7yqvoeYolCLgB9ju50rYivo";\n    }\n    axios\n      .post(url, authData)\n      .then((response) => {\n        console.log(response);\n        const expirationDate = new Date(\n          new Date().getTime() + response.data.expiresIn * 1000\n        );\n        localStorage.setItem("token", response.data.idToken);\n        localStorage.setItem("expirationDate", expirationDate);\n        localStorage.setItem("userId", response.data.localId);\n        dispatch(authSuccess(response.data.idToken, response.data.localId));\n        dispatch(checkAuthTimeout(response.data.expiresIn));\n      })\n      .catch((err) => {\n        dispatch(authFail(err.response.data.error));\n      });\n  };\n};\n\nexport const setAuthRedirectPath = (path) => {\n  return {\n    type: actionTypes.SET_AUTH_REDIRECT_PATH,\n    path: path,\n  };\n};\n\nexport const authCheckState = () => {\n  return (dispatch) => {\n    const token = localStorage.getItem("token");\n    if (!token) {\n      dispatch(logout());\n    } else {\n      const expirationDate = new Date(localStorage.getItem("expirationDate"));\n      if (expirationDate > new Date()) {\n        dispatch(logout());\n      } else {\n        const userId = localStorage.getItem("userId");\n        dispatch(authSuccess(token, userId));\n        dispatch(\n          checkAuthTimeout(\n            expirationDate.getsSeconds() - new Date().getSeconds()\n          )\n        );\n      }\n    }\n  };\n};\n')),(0,a.kt)("h2",{id:"indexjs"},(0,a.kt)("inlineCode",{parentName:"h2"},"index.js")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="src\\store\\actions\\index.js" {1}',title:'"src\\store\\actions\\index.js"',"{1}":!0},'export { auth, authCheckState, logout, setAuthRedirectPath } from "./auth";\nexport {\n  addIngredient,\n  initIngredients,\n  removeIngredient,\n} from "./burgerBuilder";\nexport { fetchOrders, purchaseBurger, purchaseInit } from "./order";\n')),(0,a.kt)("h2",{id:"appjs"},(0,a.kt)("inlineCode",{parentName:"h2"},"App.js")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-jsx",metastring:'title="src\\App.js" {2,10,13-14,33-39}',title:'"src\\App.js"',"{2,10,13-14,33-39}":!0},'import React, { Component } from "react";\nimport { connect } from "react-redux";\nimport { Route, Switch } from "react-router-dom";\nimport Layout from "./components/Layout/Layout";\nimport Auth from "./containers/Auth/Auth";\nimport Logout from "./containers/Auth/Logout/Logout";\nimport BurgerBuilder from "./containers/BurgerBuilder/BurgerBuilder";\nimport Checkout from "./containers/Checkout/Checkout";\nimport Orders from "./containers/Orders/Orders";\nimport * as actions from "./store/actions/index";\n\nclass App extends Component {\n  componentDidMount() {\n    this.props.onTryAutoSignup();\n  }\n  render() {\n    return (\n      <div>\n        <Layout>\n          <Switch>\n            <Route path="/checkout" component={Checkout} />\n            <Route path="/orders" component={Orders} />\n            <Route path="/auth" component={Auth} />\n            <Route path="/logout" component={Logout} />\n            <Route path="/" exact component={BurgerBuilder} />\n          </Switch>\n        </Layout>\n      </div>\n    );\n  }\n}\n\nconst mapDispatchtoProps = (dispatch) => {\n  return {\n    onTryAutoSignup: () => dispatch(actions.authCheckState()),\n  };\n};\n\nexport default connect(null, mapDispatchtoProps)(App);\n')))}d.isMDXComponent=!0}}]);